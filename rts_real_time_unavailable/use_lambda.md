## Lambda架构

从现在起，我们需要重新审视下自己是怎样开发程序，以及是怎样理解所开发程序的。
当我们开发Web后端时，认为无非就是增删查改，于是拿起Spring Boot就做了。
当我们开发流计算应用时，认为无非就是消息过来就处理，于是拿起Storm就干了。
当我们开发批处理任务时，认为无非就是将数据读出来后进行计算，然后输出结果就好了。
是的，针对每一种任务，我们都知道怎么去完成这个任务，然后针对具体任务，解决具体问题。

然后有一天，产品经理跑过来跟你说，功能需要增加；运维跑过来跟你说数据库要调整；
刚来的新人需要你来指导，你需要跟他讲解系统的整体结构。
这个时候你会发现，原来设计的系统已经根本理不清或者动不了了。
到处是耦合的增删查改逻辑，到处是相互依赖的输入输出，到处是乱七八糟的数据格式。
想在原来的业务流程中插入一个业务模块，一定要对系统大动干戈。
想要调整数据库，一定要修改程序代码。
想要指导新人，一定要告诉他数据在哪里增删查改。

突然，你觉得好烦。似乎一切都开始变得失控，每动一处都是伤经动骨。

造成这些问题的祸根，其实从一开始就埋下。因为在设计系统的时候，就没有一个整体的指导性原则。

当我们开发流计算系统时，亦是如此。流计算系统的本质，还是对数据的实时处理和分析。
所以我们首先应该理解数据系统的本质是什么。

### 什么是数据系统
数据系统用于根据过去所获取和累积的知识，回答当前提出的问题。
这里面有两层信息。
其一是积累知识。当有新的消息流入系统时，我们需要将它记录下来，这些消息会成为我们知识的一部分。
其二是回答问题。我们在回答当前的问题时，是依据历史积累的知识来回答这个问题。

数据系统一方面需要积累知识，另一方面可以回答问题。而且必需强调的是，积累知识和回答问题是两个独立过程。
积累知识可以是在任何时间、从任何地方收录数据，收录之后内部还有可能需要进一步归纳和整理。
回答问题则是在任何时候，根据知识库中所知道的一切，来回答任何人提出的问题。

记住积累知识和回答问题这两个过程是独立的非常重要。
因为这告诉我们，在有关数据系统的方案设计时，千万不要将查询和更新这两个过程耦合起来。
否则知识积累的过程和回答问题的过程紧密关联，这会让我们的系统在将来可能的需求变更或功能增强时，变动会非常困难。
就像之前关于状态管理的设计一样，我们明确地将update操作和get操作分离开来，根本原因也正在这个地方。

### Lambda架构思想
Lambda架构中，将数据系统抽象为一个作用在数据全集上的函数。用公式表示就是：
```
query = function(all data)
```
但是，上面的公式还只能算是一个粗略概括，不能体现Lambda架构的核心观点。

Lambda架构是为解决大数据量场景下实时查询的问题而生，它将数据系统更精细的刻画为：

```
query = function(all data) = function(batch data) ＋ function(streaming data)
```
从上面的公式可以看出，当数据量太大而不能实时全量计算时，Lambda架构将数据处理分成两部分。
一部分是基于批处理的预计算，另一部分则是基于流处理的实时增量计算。
将这两部分计算结合起来，最终得到计算结果。

至于为什么叫Lambda架构，其实是Lambda架构将数据系统视为在不可变数据集上的纯函数计算，
与函数式编程的核心思想不谋而合，而lambda表达式又是函数式编程的具体表现形式。感兴趣的读者可以查阅函数式编程相关资料。

### Lambda架构
Lambda架构分为三层：批处理层、服务层和速度层。

#### 批处理层
批处理层是为了存储主数据集和预计算各种批处理视图。
当数据进入批处理层时，数据被存储下来，并作为数据系统的主数据集。
批处理层在主数据集上预计算各种批处理视图，以供后续快速检索和查询。
基于Hadoop的分布式文件系统和批处理技术，是批处理层采用的典型方案。

#### 服务层
服务层的角色比较灵活。在不同的场景下，服务层的作用略有不同。
有些场景下，服务层只用于将批处理层的视图加载到数据库或内存中，并提供视图的查询服务。
而另一些场景下，服务层则需要合并批处理层和速度层的视图，然后提供合并后结果的查询。
服务层的实现方式可以是专用的分布式数据库，也可以是微服务系统。
服务层对外提供数据查询的接口是只读的，这对于实现一个高性能、无状态、高可靠的服务层是非常有利的因素。


#### 速度层
速度层是在批处理层视图的基础上，增量计算批处理期间新到的数据，从而最终实时完成对全量数据信息的汇总。
由于批处理层的结果在定期刷新，速度层的计算又是基于批处理层的增量计算，
当新的批处理视图到达时，基于旧视图计算的速度层视图也可以随之被删除。
所以从长期运行来看，速度层也变成了一个"无状态"的计算。
对于服务模块开发而言，"无状态"是一种非常友好的特性，它极大地降低了数据维护的复杂性，简化了程序开发的难度。
速度层的实时计算特性，决定了它需要进行大量的随机读写访问，通常可以借助于Redis这样的内存数据库来作为速度层的数据库。

### Lambda架构优缺点
Lambda架构为开发大数据量下的实时应用提供了一种切实有效的通用模式。
通过将数据和处理分为三个相对独立的无状态层，Lambda架构降低了大数据持续更新时数据分析的复杂性，
并获得了实时响应的全数据集查询结果。
不过Lambda架构也存在一个最大的问题，就是开发复杂度更高。对于同一个查询目标，需要分别为批处理和流处理开发不同的实现方法，
并且将这两种计算的结果合并起来也是一件比较繁琐的事情。
后续在Lambda架构基础上演化而来的Kappa架构，通过用同样的流处理方式替换批处理层，统一了预处理和实时处理的算法逻辑，
在一定程度上降低了Lambda架构的复杂性。

### 总结
本节讲解了当做不到实时计算时，我们设计系统的一种通用模式。
Lambda架构在其提出后，不同的开发者根据自身业务问题的需要，做出了不同的改进。
但不管怎样，这些改进的Lambda架构都是将大数据实时计算分为了离线计算、实时计算和合并计算这三大部分。
另外，我们应该掌握的是Lambda架构这种解构复杂问题、降低系统复杂性、使计算变得无状态的数据系统设计思路。
