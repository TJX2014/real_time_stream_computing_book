## 存储的设计应该根据应用类型选择

说到数据存储，大多数程序开发者最先想到的是SQL（结构化查询语言）和关系型数据库。
没错，支持SQL的关系型数据库，不管是在理论方面还是实际生产应用方面，都早已取得巨大的成功，让人映像深刻。
但直到有一天，NoSQL横空出世，顿时光芒一下子盖过作为昔日王者的SQL关系型数据库，一时风光无限。
甚至笔者还真实碰到过下面的一场对话。
```
某君A：咱们为什么要用这个数据库，它有什么优势吗？
某君B：因为它是NoSQL啊！
```
然后随着大数据库的兴起，各种以分布式系统架构设计的分布式数据库或数据仓库，
不管是SQL的，还是NoSQL的，都如雨后春笋般被开发出来。
一下子，数据库的种类和选择变得非常丰富多彩。

我想大家都应该想过这个问题，为什么有这么多各种各样的数据库啊？
不说SQL与NoSQL之分，也不说分布式与非分布式之分，
就算同样是SQL数据，还有MySQL和PostgreSQL、Oracle和SQL Server等等。
它们不都是存储数据的地方吗？为什么没有一种数据存储方案能够解决所有场景的问题呢？
很可惜的是，至少到现阶段，我们确实没有这样的数据库。
如果哪天，CPU的性能比现在提升个几亿倍，内存容量比现在提升个几亿倍，磁盘和IO性能也比现在提升个几亿倍，
并且它们的价格比现在还便宜个几十倍。那这个时候就要恭喜你了，你将获得一个支持所有场景的万能数据库。
想想是不是有点小激动？不过从白日梦中醒来，我们就知道存在各种数据库的根本原因了。
这就是，现有数据库的计算能力还不足以满足所有场景下各种类型的查询任务。
因此需要针对专门的特定场景，做出专门的设计优化。
这样造成的结果就是，每种数据库，其实都是有它擅长的特定场景，
没有一种数据库能够在所有场景下都能胜任。

## 如何选择数据库
从上节中我们知道没有在所有场景下都能使用的数据库银弹。
因此，选择使用哪种数据库，需要根据我们具体使用的场景来选择最合适的数据库。


### 实时流计算
在实时流计算中，经常会需要记录各种状态。比如前面章节中我们提到的数据信息状态，
这些状态通常是各种聚类数据和历史信息数据。
在实时流计算的过程中，这些信息种类多样，并且需要频繁的更新和读取，对数据的灵活性和访问性能有着较高的要求。
对于实时流计算中的状态存储，通常会选择NoSQL数据库。
这有两方面的原因，NoSQL数据库的数据模型更加灵活，可以简化我们的程序逻辑。
比如Redis就支持丰富的数据结构，使我们计算和维护各种状态信息非常方便。
另一方面，NoSQL数据库的性能通常比传统关系型数据库性能更好。
比如Redis单节点就能支持10万次每秒的读写性能，可以说是非常适合记录实时流计算中的各种状态了。


### 离线分析
经过实时流计算后，数据本身和计算结果通常会被保存下来，
一方面可以做数据备份，另一方面可以做各种报表统计或离线分析。
对于这种目的的数据存储，通常使用诸如HDFS的大数据文件系统。
特别是如今，Apache Hadoop已经非常成熟，构建在其上的查询和分析工具也多种多样。
比如Hive、HBase和Spark等等，都是非常好的分析工具。
这些分析工具统一在Apache Hadoop的生态体系内，对于以后更多的方案探索和选择都留有很大余地。

### 点查询
文档数据库
除了数据备份、离线报表或离线分析这类数据存储外，还有类偏重于提供实时查询计算结果的存储。
这种查询更多的会是一种点查询，即根据一个或多个健来查询相应的值。
针对这种目的的查询，通常选择NoSQL数据库并结合缓存的存储方案。
当然，如果你要查询的结果是结构化数据，也可以使用关系型数据库。
不过对于这种目的的查询而言，通常需要较高的每秒请求处理能力和较低的时延，
因此尽量地减小复杂调教，比如join操作。
使用文档数据库可以灵活地设计数据结构，对于这类查询是非常合适的。

### Adhoc查询
除了点查询外，，还有类用于交互式查询的存储方案。
比如通常实时流计算的计算结果会通过UI来呈现，如果UI要提供交互式的查询体验，那么就涉及到一类我们称之为Ad-Hoc的查询。
对于这类查询的存储方案选择，在设计时一定要考虑到前端UI的需求变化，而不能选择一个僵硬的数据存储方案，否则当UI需求变化，各种查询条件调整时，
对后端存储的变更可能是个巨大而且痛苦的挑战。针对这种情况，推荐使用搜索引擎一类的存储方案，比如ElasticSearch。


## 总结
综合而言，在相对复杂的业务场景下，实时流计算只是系统中的一个环节。针对不同计算类型和查询目的，要合理选择相应的数据存储方案。
更有甚者，很多时侯我们必须将相同内容的数据需要根据不同的需求，同时存入多种不同功能的存储方案中。至少目前为止，还没有一种称之为银弹的数据库。

在下面的章节中，我们将具体讨论各种场景下典型的数据库。